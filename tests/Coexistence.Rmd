---
title: "Coexistence"
author: "Stefan Paul"
date: "8. Juli 2016"
output: html_document
---
# Objective
This document examines competition and competition for 
quasi similar species.
It should help to better understand how the general model behavior.

```{r}
library(psfmod)
library(lattice)


colfunc <- colorRampPalette(c("blue", "white", "red"))
colvec <- colfunc(1000)

denscolfun <- colorRampPalette(c("red", "yellow", "white"))
denscol <- denscolfun(1000)

```

To start I defined a parameter set with two identical species. 
```{r}
S <- L0 <- 50

yini <- list("BA" = 100, "BB" = 100,"S" =  S,"DA" =  10, "DB" = 10,"L0"=  L0,
             "Sa"= 0.5,"Dca"= 1,"Dcb" = 1)




# Parameters
refpars <- list("gLC" = c(0.028, 0.028),  # Maximum growth rate under light limitation #DONE
             "kLC" = c(20, 20),  #      # Light availability under which 1/2 gLC is reached
             "gNC" = c(0.028, 0.028), # Maximum growth rate under nutrient limitation #DONE
             "kNC" = c(20, 20), #   # N availability under which 1/2 gNC is reached
             "mC" = c(0.001, 0.001), #   # per capita mortality rate
             "a" = 0.05, #   # turnover rate of nutrient supply. Can later be determined
             # because it determiens the biomass in equilibrium (see Eppinga 2011 Appendix)
             "S" = S, #DONE
             "qNC" = c(18, 18), #  DONE # N content of tissue
             "rho" = 1200, # DONE # soil bulk density
             "l_Root" = 1, #DONE # rooting depyth
             "QNC" = c(18, 18), #  DONE
             "alphaNC" = c(0.7, 0.7), #DONE # Nutrient litter feedback
             "dC" = c(0.015, 0.015), #DONE # Litter decomposition rate
             "cRate" = 10, #DONE
             "L0" = L0, # 
             "gamma_LC" = c(0.03, 0.03), #  # light interception coefficient
             "alpha_LC" = c(0.1, 0.1), #  # light litter feedback coefficient
             "alpha_a" = 0, # ?
             "alpha_b" = 0, # ?
             "beta_a" = 0, # partially DONE
             "beta_b" = 0, #DONE
             "sccr" = c(1,1) #DONE
)


```

As should be expected these species coexist perfectly for all possible 
combinations of light nutrient availability.

```{r}


Lseq <- seq(2, 500, len = 15)
Sseq <- seq(2, 50, len = 15)

yseq <- Lseq
xseq <- Sseq
resmat <- matrix(NA, length(xseq), length(yseq))

for(i in 1: length(xseq)){
  for(k in 1:length(yseq)){
    S <- xseq[i]
    L0 <- yseq[k]
   
    
yini <- list("BA" = 100, "BB" = 100,"S" =  S,"DA" =  10, "DB" = 10,"L0"=  L0,
             "Sa"= 0.5,"Dca"= 1,"Dcb" = 1)



pars <- modifyList(refpars, list("S" = S, "L0" = L0))

pars <- createPar(yini, pars)

out <- psfmod(pars, 5000)

    
    try(resmat[i,k] <- out[5000,2]/(out[5000,2]+out[5000,3]))


  }
}


levelplot(t(resmat), xlab = list("L0", cex = 1.3) ,ylab = list("S", cex = 1.3), at = seq(0,1,len = 1000),
          colorkey = list(col = colvec, at = seq(0,1,len = 1001),
         labels = list(at = c(0.2,0.8), labels = c("B dominant", "A dominant"), cex = 1.3)), scales = list(draw = FALSE, cex = 1.3), col.regions = colvec)


```



# Species A performs better under light limitation
Now species A is changed to be a slightly better competitor 
under light limitation. We would expect species A to become dominant
in all cases where light availability determines the competition.
As the species are still identical under nutrient limitation 
they should perfectly coexists under nutrient limitation.


```{r}


# Parameters
refpars <- list("gLC" = c(0.029, 0.028),  # Maximum growth rate under light limitation #DONE
             "kLC" = c(20, 20),  #      # Light availability under which 1/2 gLC is reached
             "gNC" = c(0.028, 0.028), # Maximum growth rate under nutrient limitation #DONE
             "kNC" = c(20, 20), #   # N availability under which 1/2 gNC is reached
             "mC" = c(0.001, 0.001), #   # per capita mortality rate
             "a" = 0.05, #   # turnover rate of nutrient supply. Can later be determined
             # because it determiens the biomass in equilibrium (see Eppinga 2011 Appendix)
             "S" = S, #DONE
             "qNC" = c(18, 18), #  DONE # N content of tissue
             "rho" = 1200, # DONE # soil bulk density
             "l_Root" = 1, #DONE # rooting depth
             "QNC" = c(18, 18), #  DONE
             "alphaNC" = c(0.7, 0.7), #DONE # Nutrient litter feedback
             "dC" = c(0.015, 0.015), #DONE # Litter decomposition rate
             "cRate" = 1, #DONE
             "L0" = L0, # 
             "gamma_LC" = c(0.001, 0.001), #  # light interception coefficient
             "alpha_LC" = c(0.001, 0.001), #  # light litter feedback coefficient   ### Changed!
             "alpha_a" = 0, # ?
             "alpha_b" = 0, # ?
             "beta_a" = 0, # partially DONE
             "beta_b" = 0, #DONE
             "sccr" = c(1,1) #DONE
)



```



```{r}

yseq <- Lseq
xseq <- Sseq
resmat <- matrix(NA, length(xseq), length(yseq))

for(i in 1: length(xseq)){
  for(k in 1:length(yseq)){
    S <- xseq[i]
    L0 <- yseq[k]
   
    
yini <- list("BA" = 100, "BB" = 100,"S" =  S,"DA" =  10, "DB" = 10,"L0"=  L0,
             "Sa"= 0.5,"Dca"= 1,"Dcb" = 1)



pars <- modifyList(refpars, list("S" = S, "L0" = L0))

pars <- createPar(yini, pars)


out <- psfmod(pars, 50000)

    try(resmat[i,k] <- out[50000,2]/(out[50000,2]+out[50000,3]))

  }
}




levelplot(t(resmat), xlab = list("L0", cex = 1.3) ,ylab = list("S", cex = 1.3), at = seq(0,1,len = 1000),
          colorkey = list(col = colvec, at = seq(0,1,len = 1001),
         labels = list(at = c(0.2,0.8), labels = c("B dominant", "A dominant"), cex = 1.3)), scales = list(draw = FALSE, cex = 1.3), col.regions = colvec)


```


# Species B performes better under nutrient limitation
This is the opposite case to the above presented. Here we would expect species B to be
dominant under nutrient limitation, whereas no effect is expected under light limitation.

```{r}


# Parameters
refpars <- list("gLC" = c(0.028, 0.028),  # Maximum growth rate under light limitation #DONE
             "kLC" = c(20, 20),  #      # Light availability under which 1/2 gLC is reached
             "gNC" = c(0.028, 0.030), # Maximum growth rate under nutrient limitation #DONE
             "kNC" = c(20, 20), #   # N availability under which 1/2 gNC is reached
             "mC" = c(0.001, 0.001), #   # per capita mortality rate
             "a" = 0.05, #   # turnover rate of nutrient supply. Can later be determined
             # because it determiens the biomass in equilibrium (see Eppinga 2011 Appendix)
             "S" = S, #DONE
             "qNC" = c(18, 18), #  DONE # N content of tissue
             "rho" = 1200, # DONE # soil bulk density
             "l_Root" = 1, #DONE # rooting depyth
             "QNC" = c(18, 18), #  DONE
             "alphaNC" = c(0.7, 0.7), #DONE # Nutrient litter feedback
             "dC" = c(0.015, 0.015), #DONE # Litter decomposition rate
             "cRate" = 10, #DONE
             "L0" = L0, # 
             "gamma_LC" = c(0.001, 0.001), #  # light interception coefficient
             "alpha_LC" = c(0.001, 0.001), #  # light litter feedback coefficient
             "alpha_a" = 0, # ?
             "alpha_b" = 0, # ?
             "beta_a" = 0, # partially DONE
             "beta_b" = 0, #DONE
             "sccr" = c(1,1) #DONE
)

```


```{r}

yseq <- Lseq
xseq <- Sseq
resmat <- matrix(NA, length(xseq), length(yseq))

for(i in 1: length(xseq)){
  for(k in 1:length(yseq)){
    S <- xseq[i]
    L0 <- yseq[k]
   
    
yini <- list("BA" = 100, "BB" = 100,"S" =  S,"DA" =  10, "DB" = 10,"L0"=  L0,
             "Sa"= 0.5,"Dca"= 1,"Dcb" = 1)




pars <- modifyList(refpars, list("S" = S, "L0" = L0))

pars <- createPar(yini, pars)


out <- psfmod(pars, 20000)

  #  plot(out, main = paste("S= ", S, "; L0= ", L0))
    
    try(resmat[i,k] <- out[20000,2]/(out[20000,2]+out[20000,3]))

  }
}



levelplot(t(resmat), xlab = list("L0", cex = 1.3) ,ylab = list("S", cex = 1.3), at = seq(0,1,len = 1000),
          colorkey = list(col = colvec, at = seq(0,1,len = 1001),
         labels = list(at = c(0.2,0.8), labels = c("B dominant", "A dominant"), cex = 1.3)), scales = list(draw = FALSE, cex = 1.3), col.regions = colvec)

```


# Species A performes better light, species B under nutrient limitation
Now we can combine the two cases above. This is a simplified case of potential
real world systems, where different species compete for limiting 
resources.
Here we would expect species A to win under light limitation and 
species B under nutrient limitation. 

```{r}


# Parameters
refpars <- list("gLC" = c(0.030, 0.028),  # Maximum growth rate under light limitation #DONE
             "kLC" = c(20, 20),  #      # Light availability under which 1/2 gLC is reached
             "gNC" = c(0.028, 0.030), # Maximum growth rate under nutrient limitation #DONE
             "kNC" = c(20, 20), #   # N availability under which 1/2 gNC is reached
             "mC" = c(0.001, 0.001), #   # per capita mortality rate
             "a" = 0.05, #   # turnover rate of nutrient supply. Can later be determined
             # because it determiens the biomass in equilibrium (see Eppinga 2011 Appendix)
             "S" = S, #DONE
             "qNC" = c(18, 18), #  DONE # N content of tissue
             "rho" = 1200, # DONE # soil bulk density
             "l_Root" = 1, #DONE # rooting depyth
             "QNC" = c(18, 18), #  DONE
             "alphaNC" = c(0.7, 0.7), #DONE # Nutrient litter feedback
             "dC" = c(0.015, 0.015), #DONE # Litter decomposition rate
             "cRate" = 10, #DONE
             "L0" = L0, # 
             "gamma_LC" = c(0.001, 0.001), #  # light interception coefficient
             "alpha_LC" = c(0.001, 0.001), #  # light litter feedback coefficient
             "alpha_a" = 0, # ?
             "alpha_b" = 0, # ?
             "beta_a" = 0, # partially DONE
             "beta_b" = 0, #DONE
             "sccr" = c(1,1) #DONE
)

```


```{r}

yseq <- Lseq
xseq <- Sseq
resmat <- matrix(NA, length(xseq), length(yseq))

for(i in 1: length(xseq)){
  for(k in 1:length(yseq)){
    S <- xseq[i]
    L0 <- yseq[k]
   
    
yini <- list("BA" = 100, "BB" = 100,"S" =  S,"DA" =  10, "DB" = 10,"L0"=  L0,
             "Sa"= 0.5,"Dca"= 1,"Dcb" = 1)



pars <- modifyList(refpars, list("S" = S, "L0" = L0))

pars <- createPar(yini, pars)


out <- psfmod(pars, 20000)
plot(out)

  try(resmat[i,k] <- out[20000,2]/(out[20000,2]+out[20000,3]))

  }
}



levelplot(t(resmat), xlab = list("L0", cex = 1.3) ,ylab = list("S", cex = 1.3), at = seq(0,1,len = 1000),
          colorkey = list(col = colvec, at = seq(0,1,len = 1001),
         labels = list(at = c(0.2,0.8), labels = c("B dominant", "A dominant"), cex = 1.3)), scales = list(draw = FALSE, cex = 1.3), col.regions = colvec)

```


# Species A performes better light, species B under nutrient limitation; including negative feedback
Negative feedbacks are believed to faciliate coexistence of species. Here I included equally strong
negative feedbacks to both species.


```{r}


# Parameters
refpars <- list("gLC" = c(0.030, 0.028),  # Maximum growth rate under light limitation #DONE
             "kLC" = c(20, 20),  #      # Light availability under which 1/2 gLC is reached
             "gNC" = c(0.028, 0.030), # Maximum growth rate under nutrient limitation #DONE
             "kNC" = c(20, 20), #   # N availability under which 1/2 gNC is reached
             "mC" = c(0.001, 0.001), #   # per capita mortality rate
             "a" = 0.05, #   # turnover rate of nutrient supply. Can later be determined
             # because it determiens the biomass in equilibrium (see Eppinga 2011 Appendix)
             "S" = S, #DONE
             "qNC" = c(18, 18), #  DONE # N content of tissue
             "rho" = 1200, # DONE # soil bulk density
             "l_Root" = 1, #DONE # rooting depyth
             "QNC" = c(18, 18), #  DONE
             "alphaNC" = c(0.7, 0.7), #DONE # Nutrient litter feedback
             "dC" = c(0.015, 0.015), #DONE # Litter decomposition rate
             "cRate" = 10, #DONE
             "L0" = L0, # 
             "gamma_LC" = c(0.001, 0.001), #  # light interception coefficient
             "alpha_LC" = c(0.001, 0.001), #  # light litter feedback coefficient
             "alpha_a" = -0.02, # ?
             "alpha_b" = 0, # ?
             "beta_a" = 0, # partially DONE
             "beta_b" = -0.02, #DONE
             "sccr" = c(1,1) #DONE
)

```


```{r}

yseq <- Lseq
xseq <- Sseq
resmat <- matrix(NA, length(xseq), length(yseq))

for(i in 1: length(xseq)){
  for(k in 1:length(yseq)){
    S <- xseq[i]
    L0 <- yseq[k]
   
    
yini <- list("BA" = 100, "BB" = 100,"S" =  S,"DA" =  10, "DB" = 10,"L0"=  L0,
             "Sa"= 0.5,"Dca"= 1,"Dcb" = 1)


pars <- modifyList(refpars, list("S" = S, "L0" = L0))

pars <- createPar(yini, pars)


out <- psfmod(pars, 20000)

  try(resmat[i,k] <- out[20000,2]/(out[20000,2]+out[20000,3]))

  }
  print(i)
}



levelplot(t(resmat), xlab = list("L0", cex = 1.3) ,ylab = list("S", cex = 1.3), at = seq(0,1,len = 1000),
          colorkey = list(col = colvec, at = seq(0,1,len = 1001),
         labels = list(at = c(0.2,0.8), labels = c("B dominant", "A dominant"), cex = 1.3)), scales = list(draw = FALSE, cex = 1.3), col.regions = colvec)

```



# Species A performes better light, species B under nutrient limitation; no litter feedbacks
```{r}


# Parameters
refpars <- list("gLC" = c(0.030, 0.028),  # Maximum growth rate under light limitation #DONE
             "kLC" = c(20, 20),  #      # Light availability under which 1/2 gLC is reached
             "gNC" = c(0.028, 0.030), # Maximum growth rate under nutrient limitation #DONE
             "kNC" = c(20, 20), #   # N availability under which 1/2 gNC is reached
             "mC" = c(0.001, 0.001), #   # per capita mortality rate
             "a" = 0.05, #   # turnover rate of nutrient supply. Can later be determined
             # because it determiens the biomass in equilibrium (see Eppinga 2011 Appendix)
             "S" = S, #DONE
             "qNC" = c(18, 18), #  DONE # N content of tissue
             "rho" = 1200, # DONE # soil bulk density
             "l_Root" = 1, #DONE # rooting depyth
             "QNC" = c(18, 18), #  DONE
             "alphaNC" = c(0, 0), #DONE # Nutrient litter feedback
             "dC" = c(0.015, 0.015), #DONE # Litter decomposition rate
             "cRate" = 10, #DONE
             "L0" = L0, # 
             "gamma_LC" = c(0.001, 0.001), #  # light interception coefficient
             "alpha_LC" = c(0, 0), #  # light litter feedback coefficient
             "alpha_a" = 0, # ?
             "alpha_b" = 0, # ?
             "beta_a" = 0, # partially DONE
             "beta_b" = 0, #DONE
             "sccr" = c(1,1) #DONE
)

```


Now we can look at the coexistence of the species.

```{r}

yseq <- Lseq
xseq <- Sseq
resmat <- matrix(NA, length(xseq), length(yseq))

for(i in 1: length(xseq)){
  for(k in 1:length(yseq)){
    S <- xseq[i]
    L0 <- yseq[k]
   
    
yini <- list("BA" = 100, "BB" = 100,"S" =  S,"DA" =  10, "DB" = 10,"L0"=  L0,
             "Sa"= 0.5,"Dca"= 1,"Dcb" = 1)



# Parameter with   don't have fitted values yet.
# For parameter with two values:
# First others, second F. paniculata
    pars <- modifyList(refpars, list("S" = S, "L0" = L0))

   pars <- createPar(yini, pars)

    
    out <- psfmod(pars, 20000)
    
    
  try(resmat[i,k] <- out[20000,2]/(out[20000,2]+out[20000,3]))

  }
}



levelplot(t(resmat), xlab = list("L0", cex = 1.3) ,ylab = list("S", cex = 1.3), at = seq(0,1,len = 1000),
          colorkey = list(col = colvec, at = seq(0,1,len = 1001),
         labels = list(at = c(0.2,0.8), labels = c("B dominant", "A dominant"), cex = 1.3)), scales = list(draw = FALSE, cex = 1.3), col.regions = colvec)

```


